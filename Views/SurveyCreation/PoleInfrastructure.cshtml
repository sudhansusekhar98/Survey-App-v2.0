@model SurveyApp.Models.PoleCantileverViewModel
@{
    ViewData["Title"] = "Pole Infrastructure";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card shadow mt-4">
                <div class="card-header bg-purple py-2">
                    <div class="row">
                        <div class="col-6">
                            <h6 class="text-white fs-4 pt-1">Pole Infrastructure</h6>
                        </div>
                        <div class="col-6 text-end">
                            <a href="@Url.Action("Index", "SurveyCreation")" class="btn btn-outline-danger text-white border-0 mx-0 my-0">
                                <i class="bi bi-arrow-left-circle me-2"></i> Back To List
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    @if (TempData["SubmitStatus"]?.ToString() == "success")
                    {
                        <div class="alert alert-success mb-4">Successfully Uploaded!</div>
                    }

                    <!-- FORM STARTS HERE (keep it open until after all sections) -->
                    <form asp-action="Index" asp-controller="PoleInfrastructure" method="post" enctype="multipart/form-data" id="poleForm">
                        @Html.AntiForgeryToken()

                        <div class="row gx-4 gy-4 mb-4">
                            <div class="col-12 col-md-4">
                                <div class="form-custom-floating">
                                    <input type="number" id="IronPoleCount" name="IronPoleCount" class="form-control" value="@Model.IronPoleCount" min="0" />
                                    <label>Iron Pole</label>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-custom-floating">
                                    <input type="number" id="ConcretePoleCount" name="ConcretePoleCount" class="form-control" value="@Model.ConcretePoleCount" min="0" />
                                    <label>Concrete Pole</label>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-custom-floating">
                                    <input type="number" id="TelecomPoleCount" name="TelecomPoleCount" class="form-control" value="@Model.TelecomPoleCount" min="0" />
                                    <label>Telecom Pole</label>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">Existing Pole Images</label>
                                <input type="file" name="ExistingPoleImages" multiple class="form-control" accept="image/*" capture="environment" />
                                <button type="button" id="captureExistingPoleImage" class="btn btn-primary btn-sm mt-2">Capture Image</button>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-custom-floating">
                                    <textarea name="ExistingPoleRemarks" rows="2" class="form-control">@Model.ExistingPoleRemarks</textarea>
                                    <label>Existing Pole Remarks</label>
                                </div>
                            </div>
                        </div>

                        <!-- SURVEILLANCE SECTION (now inside the form) -->
                        <h3 class="h5 text-primary mb-4 mt-4">New Pole Installations</h3>
                        <div class="card shadow mb-4">
                            <div class="card-header bg-purple py-2">
                                <div class="row">
                                    <div class="col-6">
                                        <h6 class="text-white fs-6 pt-1">Surveillance Pole</h6>
                                    </div>
                                    <div class="col-6 text-end">
                                        <span class="text-white me-2">Total: <span id="SurveillanceTotal" class="fw-bold">@Model.SurveillancePoles.Count.ToString("D2")</span></span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap">
                                    <label class="form-label fw-semibold">Number of Poles</label>
                                    <button type="button" id="addSurveillancePole" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle me-2"></i>Add Pole</button>
                                </div>

                                <div id="SurveillancePolesContainer" class="mb-3">
                                    @for (int p = 0; p < Model.SurveillancePoles.Count; p++)
                                    {
                                        <div class="card mb-2 pole-block" data-type="Surveillance" data-index="@p">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                                                    <strong>Pole #@(p + 1)</strong>
                                                    <button type="button" class="remove-pole btn btn-link text-danger">Remove Pole</button>
                                                </div>
                                                <div class="cantilevers-container mb-2">
                                                    @for (int c = 0; c < Model.SurveillancePoles[p].Cantilevers.Count; c++)
                                                    {
                                                        <div class="d-flex align-items-center mb-2 cantilever-block flex-wrap" data-cindex="@c" style="flex-wrap:wrap;">
                                                            <select name="SurveillancePoles[@p].Cantilevers[@c].Length" class="form-select me-2 mb-2 mb-md-0" style="max-width:120px;">
                                                                <option value="">Select Length</option>
                                                                <option value="1 Meter" selected="@(Model.SurveillancePoles[p].Cantilevers[c].Length == "1 Meter")">1 Meter</option>
                                                                <option value="2 Meter" selected="@(Model.SurveillancePoles[p].Cantilevers[c].Length == "2 Meter")">2 Meter</option>
                                                                <option value="3 Meter" selected="@(Model.SurveillancePoles[p].Cantilevers[c].Length == "3 Meter")">3 Meter</option>
                                                                <option value="4 Meter" selected="@(Model.SurveillancePoles[p].Cantilevers[c].Length == "4 Meter")">4 Meter</option>
                                                            </select>
                                                            <div class="d-flex align-items-center mb-2 mb-md-0">
                                                                <button type="button" class="qty-decrement btn btn-danger btn-sm" data-qty-input-name="SurveillancePoles[@p].Cantilevers[@c].Quantity">-</button>
                                                                <input type="number" name="SurveillancePoles[@p].Cantilevers[@c].Quantity" class="mx-2 form-control text-center" value="@Model.SurveillancePoles[p].Cantilevers[c].Quantity" min="1" style="max-width:80px;" />
                                                                <button type="button" class="qty-increment btn btn-success btn-sm" data-qty-input-name="SurveillancePoles[@p].Cantilevers[@c].Quantity">+</button>
                                                            </div>
                                                            <div class="w-100 d-block d-md-none"></div>
                                                            <button type="button" class="remove-cantilever btn btn-link text-danger ms-2 mt-2 mt-md-0">Remove</button>
                                                        </div>
                                                    }
                                                </div>
                                                <div>
                                                    <button type="button" class="add-cantilever btn btn-outline-primary btn-sm"><i class="bi bi-plus-circle me-2"></i>Add Cantilever</button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label class="form-label">Surveillance Images</label>
                                        <input type="file" name="SurveillanceDept.Images" multiple class="form-control" accept="image/*" capture="environment" />
                                        <button type="button" id="captureSurveillanceImage" class="btn btn-primary btn-sm mt-2"><i class="bi bi-camera me-2"></i>Capture Image</button>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <div class="form-custom-floating">
                                            <textarea name="SurveillanceDept.Remarks" rows="2" class="form-control">@Model.SurveillanceDept.Remarks</textarea>
                                            <label>Surveillance Remarks</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- (ALPR, Traffic, Gantry, Distance, Permission sections go here...) -->

                        <div class="row mt-3">
                            <div class="col text-end">
                                <button type="submit" class="btn btn-primary me-2"><i class="bi bi-check2-circle me-2"></i>Save & Upload</button>
                                <a href="@Url.Action("Index", "SurveyCreation")" class="btn btn-danger"><i class="bi bi-slash-circle me-2"></i>Cancel</a>
                            </div>
                        </div>

                    </form> <!-- FORM CLOSED HERE (after all sections) -->

                </div> <!-- card-body -->
            </div> <!-- card -->
        </div> <!-- col -->
    </div> <!-- row -->
</div> <!-- container -->


@section Scripts {
    <style>
        /* small thumbnail preview style */
        .img-preview-container { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        .img-preview-container img { width:64px; height:64px; object-fit:cover; border-radius:4px; border:1px solid #ddd; }
        .pole-block { position:relative; }
        .remove-pole, .remove-cantilever { cursor:pointer; }
    </style>

    <script>
        (function($) {
            $(document).ready(function() {
                // ---------- QUANTITY + / - for top inputs (uses data-target -> input id) ----------
                $(document).on('click', '.qty-increment, .qty-decrement', function(e) {
                    e.preventDefault();
                    var $btn = $(this);
                    var targetId = $btn.attr('data-target');
                    if (targetId) {
                        var $input = $('#' + targetId);
                        if ($input.length) {
                            var val = parseInt($input.val() || '0', 10);
                            if ($btn.hasClass('qty-increment')) val = val + 1;
                            else if (val > 0) val = val - 1;
                            $input.val(val);
                        }
                        return;
                    }

                    // if button has data-qty-input-name (used inside cantilever blocks)
                    var qtyName = $btn.attr('data-qty-input-name');
                    if (qtyName) {
                        // find the input within closest cantilever-block
                        var $cantBlock = $btn.closest('.cantilever-block');
                        var $input = $cantBlock.find('input[name="' + qtyName + '"]');
                        if ($input.length) {
                            var val = parseInt($input.val() || '0', 10);
                            if ($btn.hasClass('qty-increment')) val = val + 1;
                            else if (val > 1) val = val - 1; // cantilever min 1
                            $input.val(val);
                        }
                    }
                });

                // ---------- Capture image buttons -> trigger file input ----------
                function wireCaptureButton(btnSelector, inputSelector, previewContainerSelector) {
                    $(document).on('click', btnSelector, function(e) {
                        e.preventDefault();
                        var $input = $(inputSelector);
                        if ($input.length) $input.trigger('click');
                    });

                    // when files selected, show previews
                    $(document).on('change', inputSelector, function(e) {
                        var files = this.files;
                        showPreviews(files, previewContainerSelector, this);
                    });
                }

                // Initialize for each input present on page
                wireCaptureButton('#captureExistingPoleImage', 'input[name="ExistingPoleImages"]', '.existing-pole-previews');
                wireCaptureButton('#captureSurveillanceImage', 'input[name="SurveillanceDept.Images"]', '.surveillance-previews');
                wireCaptureButton('#captureALPRImage', 'input[name="ALPRDept.Images"]', '.alpr-previews');
                wireCaptureButton('#captureTrafficImage', 'input[name="TrafficDept.Images"]', '.traffic-previews');
                wireCaptureButton('#captureGantryImage', 'input[name="Gantry.Images"]', '.gantry-previews');

                // create preview containers if not present (placed just after file inputs)
                function ensurePreviewContainer(inputSelector, containerClass) {
                    $(inputSelector).each(function() {
                        var $input = $(this);
                        if ($input.next('.' + containerClass.replace('.', '')).length === 0) {
                            $input.after('<div class="' + containerClass.replace('.', '') + ' img-preview-container"></div>');
                        }
                    });
                }
                ensurePreviewContainer('input[name="ExistingPoleImages"]', '.existing-pole-previews');
                ensurePreviewContainer('input[name="SurveillanceDept.Images"]', '.surveillance-previews');
                ensurePreviewContainer('input[name="ALPRDept.Images"]', '.alpr-previews');
                ensurePreviewContainer('input[name="TrafficDept.Images"]', '.traffic-previews');
                ensurePreviewContainer('input[name="Gantry.Images"]', '.gantry-previews');

                // helper to show preview thumbnails
                function showPreviews(files, previewContainerSelector, fileInputElem) {
                    var $container;
                    if (previewContainerSelector) {
                        $container = $(fileInputElem).nextAll(previewContainerSelector.split('.').join('')).first();
                    }
                    if (!$container || $container.length === 0) {
                        $container = $(previewContainerSelector);
                    }
                    if (!$container || $container.length === 0) return;

                    $container.empty();
                    if (!files || files.length === 0) return;

                    Array.from(files).forEach(function(file) {
                        if (!file.type.startsWith('image/')) return;
                        var img = document.createElement('img');
                        img.alt = file.name;
                        img.title = file.name;
                        // use object URL for performance
                        img.src = URL.createObjectURL(file);
                        // revoke object URL once loaded to free memory
                        img.onload = function() { URL.revokeObjectURL(this.src); };
                        $container.append(img);
                    });
                }

                // ---------- Add / Remove simple pole blocks (Surveillance/ALPR/Traffic) ----------
                function updateTotals() {
                    $('#SurveillanceTotal').text(('0' + $('.pole-block[data-type="Surveillance"]').length).slice(-2));
                    $('#ALPRTotal').text(('0' + $('.pole-block[data-type="ALPR"]').length).slice(-2));
                    $('#TrafficTotal').text(('0' + $('.pole-block[data-type="Traffic"]').length).slice(-2));
                }

                // Add Surveillance pole
                $('#addSurveillancePole').on('click', function() {
                    var idx = $('#SurveillancePolesContainer .pole-block').length;
                    var template = `
                        <div class="card mb-2 pole-block" data-type="Surveillance" data-index="${idx}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                                    <strong>Pole #${idx + 1}</strong>
                                    <button type="button" class="remove-pole btn btn-link text-danger">Remove Pole</button>
                                </div>
                                <div class="cantilevers-container mb-2">
                                    ${buildCantileverHtml('SurveillancePoles', idx)}
                                </div>
                                <div>
                                    <button type="button" class="add-cantilever btn btn-outline-primary btn-sm">Add Cantilever</button>
                                </div>
                            </div>
                        </div>`;
                    $('#SurveillancePolesContainer').append(template);
                    updateTotals();
                });

                // Add ALPR pole
                $('#addALPRPole').on('click', function() {
                    var idx = $('#ALPRPolesContainer .pole-block').length;
                    var template = `
                        <div class="card mb-2 pole-block" data-type="ALPR" data-index="${idx}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                                    <strong>Pole #${idx + 1}</strong>
                                    <button type="button" class="remove-pole btn btn-link text-danger">Remove Pole</button>
                                </div>
                                <div class="cantilevers-container mb-2">
                                    ${buildCantileverHtml('ALPRPoles', idx)}
                                </div>
                                <div>
                                    <button type="button" class="add-cantilever btn btn-outline-primary btn-sm">Add Cantilever</button>
                                </div>
                            </div>
                        </div>`;
                    $('#ALPRPolesContainer').append(template);
                    updateTotals();
                });

                // Add Traffic pole
                $('#addTrafficPole').on('click', function() {
                    var idx = $('#TrafficPolesContainer .pole-block').length;
                    var template = `
                        <div class="card mb-2 pole-block" data-type="Traffic" data-index="${idx}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
                                    <strong>Pole #${idx + 1}</strong>
                                    <button type="button" class="remove-pole btn btn-link text-danger">Remove Pole</button>
                                </div>
                                <div class="cantilevers-container mb-2">
                                    ${buildCantileverHtml('TrafficPoles', idx)}
                                </div>
                                <div>
                                    <button type="button" class="add-cantilever btn btn-outline-primary btn-sm">Add Cantilever</button>
                                </div>
                            </div>
                        </div>`;
                    $('#TrafficPolesContainer').append(template);
                    updateTotals();
                });

                // Remove pole
                $(document).on('click', '.remove-pole', function(e) {
                    e.preventDefault();
                    $(this).closest('.pole-block').remove();
                    // re-index labels
                    $('.pole-block').each(function(i) {
                        $(this).find('strong').first().text('Pole #' + (i + 1));
                    });
                    updateTotals();
                });

                // Add cantilever inside a pole block (uses same template builder)
                $(document).on('click', '.add-cantilever', function(e) {
                    e.preventDefault();
                    var $pole = $(this).closest('.pole-block');
                    var type = $pole.data('type'); // Surveillance/ALPR/Traffic
                    var idx = $pole.data('index') || $('.pole-block[data-type="' + type + '"]').index($pole);
                    var cCount = $pole.find('.cantilever-block').length;
                    $pole.find('.cantilevers-container').append(buildCantileverHtml((type + 'Poles'), idx, cCount));
                });

                // Remove cantilever
                $(document).on('click', '.remove-cantilever', function(e) {
                    e.preventDefault();
                    $(this).closest('.cantilever-block').remove();
                });

                // helper to build cantilever HTML (with proper name attributes for model binding)
                function buildCantileverHtml(listName, poleIndex, cantIndex = 0) {
                    // name pattern: e.g. SurveillancePoles[0].Cantilevers[0].Length
                    var lengthName = listName + '[' + poleIndex + '].Cantilevers[' + cantIndex + '].Length';
                    var qtyName = listName + '[' + poleIndex + '].Cantilevers[' + cantIndex + '].Quantity';
                    return `<div class="d-flex align-items-center mb-2 cantilever-block flex-wrap" data-cindex="${cantIndex}" style="flex-wrap:wrap;">
                                <select name="${lengthName}" class="form-select me-2 mb-2 mb-md-0" style="max-width:120px;">
                                    <option value="">Select Length</option>
                                    <option value="1 Meter">1 Meter</option>
                                    <option value="2 Meter">2 Meter</option>
                                    <option value="3 Meter">3 Meter</option>
                                    <option value="4 Meter">4 Meter</option>
                                </select>
                                <div class="d-flex align-items-center mb-2 mb-md-0">
                                    <button type="button" class="qty-decrement btn btn-danger btn-sm" data-qty-input-name="${qtyName}">-</button>
                                    <input type="number" name="${qtyName}" class="mx-2 form-control text-center" value="1" min="1" style="max-width:80px;" />
                                    <button type="button" class="qty-increment btn btn-success btn-sm" data-qty-input-name="${qtyName}">+</button>
                                </div>
                                <div class="w-100 d-block d-md-none"></div>
                                <button type="button" class="remove-cantilever btn btn-link text-danger ms-2 mt-2 mt-md-0">Remove</button>
                            </div>`;
                }

                // initialize existing previews for inputs that may already have files (if page reloads)
                $('input[type="file"]').each(function() {
                    var $input = $(this);
                    if ($input[0].files && $input[0].files.length) {
                        showPreviews($input[0].files, null, this);
                    }
                });

                // small UX: prevent form submission when pressing Enter on numeric fields to avoid accidental submits
                $(document).on('keypress', 'input[type="number"]', function(e) {
                    if (e.which === 13) { e.preventDefault(); return false; }
                });
            });
        })(jQuery);
    </script>
}
