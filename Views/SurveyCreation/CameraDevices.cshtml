@{
	var cameraTypes = new[] {
		"ALPR Camera",
		"Bullet Camera",
		"Dome Camera",
		"PTZ Camera",
		"Thermal Camera",
		"FRS - Facial Recognition System"
	};
}
<style>
.cam-preview-wrapper{width:120px;height:90px;overflow:hidden;border:1px solid #dee2e6;border-radius:4px;padding:4px;background:#fff;position:relative}
.cam-preview-img{width:100%;height:100%;object-fit:cover}
.cam-preview-wrapper .btn-danger.position-absolute{display:none;top:2px;right:2px;z-index:2}
.cam-preview-wrapper:hover .btn-danger.position-absolute{display:block}
</style>

<div class="container-fluid">
	<div class="row">
		<div class="col-12">
			<div class="card shadow mt-4">
<div class="container py-4">
	<div class="card-header bg-purple py-2">
		<div class="row">
			<div class="col-6"><h6 class="text-white fs-4 pt-1">Camera Devices</h6></div>
			@* <div class="col-6 text-end"><h6 class="text-white fs-4 pt-1">@surveyName - @locID</h6></div> *@
		</div>
	</div>
      </div>
	<!-- Existing Devices Section -->
	<div class="card mb-4">
		<div class="card-body">
			<h6 class="mb-3">Select the existing types and quantities of cameras <span class="text-danger">*</span></h6>
			<form>
				<div class="row g-3 align-items-center">
					@foreach (var cam in cameraTypes)
					{
						<div class="col-md-12 mb-2">
							<div class="d-flex align-items-center cam-device-row">
								<button type="button" class="btn btn-danger btn-sm me-2 cam-qty-minus"><i class="bi bi-dash"></i></button>
								<input type="number" class="form-control text-center mx-1 cam-qty-input" value="0" min="0" style="width:60px;" />
								<button type="button" class="btn btn-success btn-sm ms-2 cam-qty-plus"><i class="bi bi-plus"></i></button>
								<span class="ms-3">@cam</span>
							</div>
							<div class="cam-extra-section card mt-2 p-3" style="display:none;">
								<div class="mb-2">
									<label class="form-label">Images</label>
									<input type="file" class="form-control mb-2 cam-upload-input" multiple accept="image/*" style="display:none;" />
									<button type="button" class="btn btn-primary me-2 cam-take-photo-btn"><i class="bi bi-camera"></i> Take Photo</button>
									<button type="button" class="btn btn-secondary cam-gallery-btn"><i class="bi bi-images"></i> Gallery</button>
									<div class="cam-preview mt-2 d-flex flex-wrap gap-2"></div>
								</div>
								<div>
									<label class="form-label">Remarks</label>
									<textarea class="form-control" placeholder="Enter remarks..."></textarea>
								</div>
							</div>
						</div>
					}
				</div>
				<div class="row mt-3">
					<div class="col-md-8">
						<input type="text" class="form-control" placeholder="Add Other Existing Devices" />
					</div>
					<div class="col-md-4">
						<button type="button" class="btn btn-primary"><i class="bi bi-plus"></i></button>
					</div>
				</div>
			</form>
		</div>
	</div>

	<!-- New Devices Section -->
	<div class="card mb-4" style="background:#f6fafd;">
		<div class="card-body">
			<h6 class="mb-3">Please select the types and quantities of cameras to be deployed</h6>
			<form>
				<div class="row g-3 align-items-center">
					@foreach (var cam in cameraTypes)
					{
						<div class="col-md-12 mb-2">
							<div class="d-flex align-items-center cam-device-row">
								<button type="button" class="btn btn-danger btn-sm me-2 cam-qty-minus"><i class="bi bi-dash"></i></button>
								<input type="number" class="form-control text-center mx-1 cam-qty-input" value="0" min="0" style="width:60px;" />
								<button type="button" class="btn btn-success btn-sm ms-2 cam-qty-plus"><i class="bi bi-plus"></i></button>
								<span class="ms-3">@cam</span>
							</div>
							<div class="cam-extra-section card mt-2 p-3" style="display:none;">
								<div class="mb-2">
									<label class="form-label">Images</label>
									<input type="file" class="form-control mb-2 cam-upload-input" multiple accept="image/*" style="display:none;" />
									<button type="button" class="btn btn-primary me-2 cam-take-photo-btn"><i class="bi bi-camera"></i> Take Photo</button>
									<button type="button" class="btn btn-secondary cam-gallery-btn"><i class="bi bi-images"></i> Gallery</button>
									<div class="cam-preview mt-2 d-flex flex-wrap gap-2"></div>
								</div>
								<div>
									<label class="form-label">Remarks</label>
									<textarea class="form-control" placeholder="Enter remarks..."></textarea>
								</div>
							</div>
						</div>
					}
				</div>
				<div class="row mt-3">
					<div class="col-md-8">
						<input type="text" class="form-control" placeholder="Add Other New Devices" />
					</div>
					<div class="col-md-4">
						<button type="button" class="btn btn-primary"><i class="bi bi-plus"></i></button>
					</div>
				</div>
				<div class="row mt-3">
					<div class="col-12">
						<textarea class="form-control" placeholder="Mounting Details (Overall)
                            Location, visibility, obstructions, sunlight, dust, vibration..." rows="2"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
		</div>
	</div>
</div>

<!-- Camera Capture Modal -->
<div id="camDeviceVideoModal" class="modal fade" tabindex="-1">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Capture Image</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body text-center">
				<video id="camDeviceCaptureVideo" autoplay playsinline style="max-width:100%;height:400px;border-radius:8px;"></video>
				<div class="mt-3 d-flex justify-content-center gap-3">
					<button type="button" class="btn btn-gradient-primary px-4 py-2 fw-semibold" id="camDeviceCaptureBtn"><i class="bi bi-camera me-2"></i> Capture</button>
					<button type="button" class="btn btn-outline-danger px-4 py-2 fw-semibold" data-bs-dismiss="modal"><i class="bi bi-x-circle me-2"></i> Cancel</button>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	document.addEventListener('click', function (e) {
		// Use closest to ensure button click works even if icon is clicked
		const plusBtn = e.target.closest('.cam-qty-plus');
		const minusBtn = e.target.closest('.cam-qty-minus');
		if (!plusBtn && !minusBtn) return;

		const row = e.target.closest('.cam-device-row');
		if (!row) return;
		const input = row.querySelector('.cam-qty-input');
		if (!input) return;

		let current = parseInt(input.value, 10);
		if (isNaN(current) || current < 0) current = 0;

		if (plusBtn) {
			current++;
			input.value = current;
			updateExtraSection(input);
		}
		if (minusBtn) {
			if (current > 0) current--;
			input.value = current;
			updateExtraSection(input);
		}
	});

	document.addEventListener('input', function (e) {
		if (e.target.classList.contains('cam-qty-input')) {
			let val = parseInt(e.target.value, 10);
			if (isNaN(val) || val < 0) val = 0;
			e.target.value = val;
			updateExtraSection(e.target);
		}
	});

	function updateExtraSection(input) {
		if (!input) return;
		const row = input.closest('.col-md-12');
		const qty = parseInt(input.value, 10) || 0;
		const extraSection = row.querySelector('.cam-extra-section');
		if (extraSection) {
			extraSection.style.display = qty > 0 ? '' : 'none';
		}
	}

	// Camera and Gallery logic
	document.addEventListener('click', function (e) {
		// Take Photo
		if (e.target.closest('.cam-take-photo-btn')) {
			const btn = e.target.closest('.cam-take-photo-btn');
			const section = btn.closest('.cam-extra-section');
			const preview = section.querySelector('.cam-preview');
			const modal = new bootstrap.Modal(document.getElementById('camDeviceVideoModal'));
			const video = document.getElementById('camDeviceCaptureVideo');
			const captureBtn = document.getElementById('camDeviceCaptureBtn');
			let stream = null;
			video.srcObject = null;
			
			if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
				navigator.mediaDevices.getUserMedia({ video: true }).then(function (s) {
					stream = s;
					video.srcObject = stream;
					modal.show();
					
					captureBtn.onclick = function () {
						let canvas = document.createElement('canvas');
						canvas.width = video.videoWidth;
						canvas.height = video.videoHeight;
						canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
						
						let wrapper = document.createElement('div');
						wrapper.className = 'cam-preview-wrapper position-relative d-inline-block';
						let img = document.createElement('img');
						img.src = canvas.toDataURL('image/png');
						img.className = 'cam-preview-img';
						wrapper.appendChild(img);
						
						let cancelBtn = document.createElement('button');
						cancelBtn.className = 'btn btn-sm btn-danger position-absolute';
						cancelBtn.innerHTML = '<i class="bi bi-x"></i>';
						cancelBtn.onclick = function () { wrapper.remove(); };
						wrapper.appendChild(cancelBtn);
						
						preview.appendChild(wrapper);
						modal.hide();
						if (stream) stream.getTracks().forEach(track => track.stop());
					};
					
					document.getElementById('camDeviceVideoModal').addEventListener('hidden.bs.modal', function () {
						if (stream) stream.getTracks().forEach(track => track.stop());
					}, { once: true });
				}).catch(function (err) {
					alert('Camera access denied.');
				});
			} else {
				alert('Camera not supported.');
			}
		}
		
		// Gallery Upload
		if (e.target.closest('.cam-gallery-btn')) {
			const btn = e.target.closest('.cam-gallery-btn');
			const section = btn.closest('.cam-extra-section');
			const uploadInput = section.querySelector('.cam-upload-input');
			const preview = section.querySelector('.cam-preview');
			uploadInput.click();
			uploadInput.onchange = function () {
				Array.from(uploadInput.files).forEach(file => {
					if (file.type.startsWith('image/')) {
						let reader = new FileReader();
						reader.onload = function (e) {
							let wrapper = document.createElement('div');
							wrapper.className = 'cam-preview-wrapper position-relative d-inline-block';
							let img = document.createElement('img');
							img.src = e.target.result;
							img.className = 'cam-preview-img';
							wrapper.appendChild(img);
							
							let cancelBtn = document.createElement('button');
							cancelBtn.className = 'btn btn-sm btn-danger position-absolute';
							cancelBtn.innerHTML = '<i class="bi bi-x"></i>';
							cancelBtn.onclick = function () { wrapper.remove(); };
							wrapper.appendChild(cancelBtn);
							
							preview.appendChild(wrapper);
						};
						reader.readAsDataURL(file);
					}
				});
			};
		}
	});
</script>
